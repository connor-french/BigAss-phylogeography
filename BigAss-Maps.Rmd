---
title: "BigAss bird phylogeography data exploration"
output: html_notebook
---
Here are some maps exploring our bird data. I have two sets of maps: Maps only with cells where there are at least three individuals per species (>= 3 species tab), and maps that show the species density, rather than observation density (Species density tab). 

First I'm reading in the packages and setting my working directory where the data is, and reading in the data.
```{r, results='hide'}
packages <- c("magrittr", "tidyverse", "sf", "leaflet", "maps", "ggmap", "viridis", "raster", "maptools", "data.table")
lapply(packages, require, character.only = TRUE)

setwd("/Users/connorfrench/Dropbox/Old_Mac/School_Stuff/CUNY/BigAss-bird-phylogeography/BigAss-phylogeography")

#read in data
bird_data <- read.csv("sample_key_68_clean.csv")
```


I'm removing all of the irrelevant columns for mapping, I'm only keeping ingroup individuals, and I'm removing all localities that aren't in South America.

```{r}
#remove irrelevant columns, NAs, North American/European localities,and subset for ingroup individuals. orig # obs = 18954; filtered # obs = 2825
bird_data <- subset(bird_data, select = c("Country", "State", "Locality", "Genus", "Species", "Ingroup", "Lat", "Long")) %>%
  subset(Ingroup == "y") %>%
  subset(Lat < 12.5) %>%
  subset(!(Country %in% c("Mexico", "Cuba", "Bahamas", "Dominican Republic", "Nicaragua", "Costa Rica", "Panama"))) %>% 
  na.omit() %>%
  droplevels.data.frame()


```

The original number of observations was 18954, and the filtered number of observations is 2825.

Now time for the map! This is of all of our South American localities colored according to country to find outlier/mislabeled points.

```{r}
#convert locality data to a spatial object. The spatial object is basically a shape file that the mapping function can interpret. 
coords <- cbind.data.frame(Long = bird_data$Long, Lat = bird_data$Lat)
coord_points <- st_as_sf(bird_data, coords = c("Long", "Lat"), 
                         crs = 4326, agr = "constant")


#load a world map as the base map.
w_map <- map("world", plot = FALSE)

#make color palette
pal <- colorFactor(palette = "inferno", domain = NULL, na.color = "#00000000")

#create popup labels for points
popup_label <- paste(coord_points$Genus, coord_points$Species, "<br>",
                     coord_points$Country, "<br>",
                     coord_points$Locality, "<br>",
                     coord_points$geometry)

#plot in leafly
leaflet(data = w_map) %>% 
  addTiles() %>%
  addCircleMarkers(data = coord_points,
                  color = ~pal(Country),
                  radius = 5,
                  popup = popup_label)
```


Now I'm going to apply various filters to the data to look at sampling intensity.

##Sampling Maps {.tabset}


###>=3 per species
Here I'm subsetting the data for only those cells where there are more than 3 observations for a species and then plotting.

100x100 km. Dataset is reduced from 68 to 49 species and from 2825 observations to 1700 observations.
```{r}
#create a numeric color palette so I can bin the colors (doing this up front so I don't repeatedly assign this variable)
pal2 <- colorNumeric(palette = "inferno", domain = NULL, na.color = "#00000000") 
#Reading in an environmental raster (world clim 2.0 bio1 raster) at 10 arc-minute resolution to use as a raster that utilizes lat-long coordinates for its cells. The raster isn't what's important, what is important is the raster resolution. 
f <- "/Users/connorfrench/Dropbox/Old_Mac/climate-data/wc2.0_10m_bio/wc2.0_bio_10m_01.tif" #raster location

bounds <- extent(-80, -35, -40, 15) #Reduce extent of raster to our area of interest- South America

sa_clim_1d <- raster(f) %>% crop(bounds) %>% aggregate(fact = 6) #read in raster, crop it, and downscale the resolution to 1 degree

#get the cell number of each coordinate pair for filtering
pts_ext_1d <- raster::extract(sa_clim_1d, coord_points, fun = "count", sp = TRUE, cellnumbers = TRUE) %>% 
  as.data.frame() %>%
  setnames(old = c("coords.x1", "coords.x2"), new = c("Long", "Lat")) %>% #rename coordinates 
  mutate(cells = as.factor(cells)) %>% #need cells numbers as factors so I can count their frequency
  group_by(Species, cells) %>% #group the data set by species, then by cell number
  filter(n() > 2) %>% #retain only observations where there are more than two species observations per cell
  ungroup()

coordinates(pts_ext_1d) <- ~Long+Lat #convert to a spatial data frame

count_pts_1d <- rasterize(pts_ext_1d, sa_clim_1d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell


#plot count map
leaflet(data = sa_clim_1d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_1d, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_1d))
```




200x200 km. 68 to 49 species and 2825 to 1955 observations

```{r}
sa_clim_2d <- raster(f) %>% crop(bounds) %>% aggregate(fact = 12) #read in raster, crop it, and downscale the resolution to 1 degree

#get the cell number of each coordinate pair for filtering
pts_ext_2d <- extract(sa_clim_2d, coord_points, fun = "count", sp = TRUE, cellnumbers = TRUE) %>% 
  as.data.frame() %>%
  setnames(old = c("coords.x1", "coords.x2"), new = c("Long", "Lat")) %>% #rename coordinates 
  mutate(cells = as.factor(cells)) %>% #need cells numbers as factors so I can count their frequency
  group_by(Species, cells) %>% #group the data set by species, then by cell number
  filter(n() > 2) %>% #retain only observations where there are more than two species observations per cell
  ungroup()

coordinates(pts_ext_2d) <- ~Long+Lat #convert to a spatial data frame

count_pts_2d <- rasterize(pts_ext_2d, sa_clim_2d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell


#plot count map
leaflet(data = sa_clim_2d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_2d, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_2d))
```


300x300 km. 68 to 54 species and 2825 to 2149 observations

```{r}
sa_clim_3d <- raster(f) %>% crop(bounds) %>% aggregate(fact = 18) #read in raster, crop it, and downscale the resolution to 1 degree

#get the cell number of each coordinate pair for filtering
pts_ext_3d <- extract(sa_clim_3d, coord_points, fun = "count", sp = TRUE, cellnumbers = TRUE) %>% 
  as.data.frame() %>%
  setnames(old = c("coords.x1", "coords.x2"), new = c("Long", "Lat")) %>% #rename coordinates 
  mutate(cells = as.factor(cells)) %>% #need cells numbers as factors so I can count their frequency
  group_by(Species, cells) %>% #group the data set by species, then by cell number
  filter(n() > 2) %>% #retain only observations where there are more than two species observations per cell
  ungroup()

coordinates(pts_ext_3d) <- ~Long+Lat #convert to a spatial data frame

count_pts_3d <- rasterize(pts_ext_3d, sa_clim_3d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell

#plot count map
leaflet(data = sa_clim_3d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_3d, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_3d))
```


###Species density
Now I'm going to look at species density per cell for the three resolutions! Just to be clear, this is still using the data set filtered for >= 3 observations per species per cell.

100 km. 
```{r}
pts_ext_1d_sp <- as.data.frame(pts_ext_1d) #convert to data frame for filtering
pts_ext_1d_sp <- pts_ext_1d_sp[!duplicated(pts_ext_1d_sp[c("Species", "cells")]),] #filter for unique species in each cell

coordinates(pts_ext_1d_sp) <- ~Long+Lat #convert to a spatial data frame

count_pts_1d_sp <- rasterize(pts_ext_1d_sp, sa_clim_1d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell


#plot count map
leaflet(data = sa_clim_1d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_1d_sp, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_1d_sp))


```

200 km.
```{r}
pts_ext_2d_sp <- as.data.frame(pts_ext_2d) #convert to data frame for filtering
pts_ext_2d_sp <- pts_ext_2d_sp[!duplicated(pts_ext_2d_sp[c("Species", "cells")]),] #filter for unique species in each cell

coordinates(pts_ext_2d_sp) <- ~Long+Lat #convert to a spatial data frame

count_pts_2d_sp <- rasterize(pts_ext_2d_sp, sa_clim_2d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell


#plot count map
leaflet(data = sa_clim_2d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_2d_sp, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_2d_sp))
```


300 km.
```{r}
pts_ext_3d_sp <- as.data.frame(pts_ext_3d) #convert to data frame for filtering
pts_ext_3d_sp <- pts_ext_3d_sp[!duplicated(pts_ext_3d_sp[c("Species", "cells")]),] #filter for unique species in each cell

coordinates(pts_ext_3d_sp) <- ~Long+Lat #convert to a spatial data frame

count_pts_3d_sp <- rasterize(pts_ext_3d_sp, sa_clim_3d, fun = "count", field = "Species") #make a raster out of the counts of observations per cell


#plot count map
leaflet(data = sa_clim_3d) %>% 
  addTiles() %>%
  addRasterImage(count_pts_3d_sp, colors = pal2,  opacity = 0.8) %>%
  addLegend(pal = pal2, values = values(count_pts_3d_sp))
```












